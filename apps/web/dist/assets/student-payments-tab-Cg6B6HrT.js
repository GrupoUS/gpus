import{b as l,j as e}from"./vendor-C0IzTJ68.js";import{ab as E,ac as se,p as t,aJ as re,bG as ne,cc as te,ce as le}from"./ui-eQKuYNMj.js";import{t as $,D as k,a8 as oe,o as H,q as X,r as _,W as M,O as n,y as A,z,E as V,G as R,H as v,I as B,T as ie,f as c,X as ce,C as de,c as me,af as ue,ag as xe,ah as O,ai as m,aj as he,ak as pe,am as L,B as je}from"./index-C8YxpUQT.js";import"./auth-CS6YH2iJ.js";import"./animation-oFsG5JPT.js";import"./forms-CH1lNzbM.js";import"./charts-CKNPyqfB.js";function ge({studentId:p,trigger:s}){const[y,d]=l.useState(!1),[j,D]=l.useState(!1),i=l.useId(),u=`${i}-billingType`,g=`${i}-value`,x=`${i}-installments`,f=`${i}-dueDate`,b=`${i}-description`,[r,o]=l.useState("PIX"),[N,q]=l.useState(""),[S,G]=l.useState(""),[Q,U]=l.useState(""),[J,W]=l.useState("1"),{data:C}=$.students.get.useQuery({id:p}),w=C?.asaasCustomerId,I=C?.asaasCustomerSyncError,K=C?.name||"Aluno",T=C?.cpf,Y=()=>{try{t.info("Sincronização não disponível",{description:"O módulo Asaas está em implementação."})}catch(a){const h=a instanceof Error?a.message:"Erro desconhecido";t.error("Falha na sincronização",{description:h})}},Z=()=>{if(!w)return t.error("Aluno não sincronizado com Asaas",{description:"O aluno precisa ter CPF e ser sincronizado antes de criar cobranças."}),null;if(!T)return t.error("CPF obrigatório",{description:"O aluno precisa ter CPF cadastrado para gerar cobranças."}),null;const a=Number.parseFloat(N);if(!a||a<=0)return t.error("Valor inválido",{description:"Informe um valor maior que zero."}),null;if(!S)return t.error("Data de vencimento obrigatória"),null;const h=new Date(S),P=new Date;return P.setHours(0,0,0,0),h<P?(t.error("Data de vencimento inválida",{description:"A data de vencimento deve ser hoje ou no futuro."}),null):{numericValue:a,asaasCustomerId:w}},ee=()=>{Z()&&t.info("Criação de cobrança não disponível",{description:"O módulo financeiro está em implementação."})},ae=e.jsxs(c,{variant:"outline",children:[e.jsx(se,{className:"mr-2 h-4 w-4"}),"Criar Cobrança"]}),F=!!w&&!!T;return e.jsxs(k,{onOpenChange:d,open:y,children:[e.jsx(oe,{asChild:!0,children:s||ae}),e.jsxs(H,{className:"sm:max-w-md",children:[e.jsxs(X,{children:[e.jsx(_,{children:"Nova Cobrança Asaas"}),e.jsxs(M,{children:["Crie uma cobrança para ",K]})]}),F?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:u,children:"Forma de Pagamento"}),e.jsxs(A,{onValueChange:a=>o(a),value:r,children:[e.jsx(z,{id:u,children:e.jsx(V,{placeholder:"Selecione"})}),e.jsxs(R,{children:[e.jsx(v,{value:"PIX",children:"PIX"}),e.jsx(v,{value:"BOLETO",children:"Boleto Bancário"}),e.jsx(v,{value:"CREDIT_CARD",children:"Cartão de Crédito"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:g,children:"Valor Total (R$)"}),e.jsx(B,{id:g,min:"0.01",onChange:a=>q(a.target.value),placeholder:"0,00",step:"0.01",type:"number",value:N})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:x,children:"Parcelas"}),e.jsxs(A,{onValueChange:W,value:J,children:[e.jsx(z,{id:x,children:e.jsx(V,{placeholder:"Selecione"})}),e.jsx(R,{children:Array.from({length:12},(a,h)=>h+1).map(a=>e.jsxs(v,{value:a.toString(),children:[a,"x"," ",a>1&&N&&`de ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number.parseFloat(N)/a)}`]},a))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:f,children:"Data de Vencimento"}),e.jsx(B,{id:f,min:new Date().toISOString().split("T")[0],onChange:a=>G(a.target.value),type:"date",value:S})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:b,children:"Descrição (opcional)"}),e.jsx(ie,{id:b,onChange:a=>U(a.target.value),placeholder:"Mensalidade, Matrícula, etc.",rows:2,value:Q})]})]}):e.jsxs("div",{className:"rounded-md border border-yellow-500/20 bg-yellow-500/10 p-4 text-sm text-yellow-600",children:[e.jsx("p",{className:"mb-1 font-medium",children:"Aluno não pode receber cobranças"}),e.jsx("p",{className:"text-xs",children:T?I?`Erro na sincronização: ${I}. Clique em "Sincronizar" para tentar novamente.`:"O aluno precisa ser sincronizado com o Asaas. Edite e salve o aluno para sincronizar.":"Cadastre o CPF do aluno primeiro."}),I&&e.jsx(c,{className:"mt-2",onClick:Y,size:"sm",variant:"outline",children:"Sincronizar Agora"})]}),e.jsxs(ce,{children:[e.jsx(c,{onClick:()=>d(!1),variant:"outline",children:"Cancelar"}),e.jsxs(c,{disabled:j||!F,onClick:ee,children:[j&&e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"}),"Gerar Cobrança"]})]})]})]})}const fe={PENDING:{label:"Pendente",className:"bg-yellow-500"},RECEIVED:{label:"Recebido",className:"bg-green-500"},CONFIRMED:{label:"Confirmado",className:"bg-green-600"},OVERDUE:{label:"Vencido",className:"bg-red-500"},REFUNDED:{label:"Reembolsado",className:"bg-purple-500"},DELETED:{label:"Excluído",className:"bg-gray-400"},CANCELLED:{label:"Cancelado",className:"bg-gray-500"}};function we({studentId:p}){const[s,y]=l.useState(null),{data:d}=$.students.get.useQuery({id:p}),j=d?.asaasCustomerId,D=d?.asaasCustomerSyncedAt,i=void 0,u=r=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(r),g=r=>r?(typeof r=="string"?new Date(r):new Date(r)).toLocaleDateString("pt-BR"):"-",x=r=>r?new Date(r).toLocaleString("pt-BR"):"-",f=r=>{const o=fe[r]||{label:r,className:"bg-gray-500"};return e.jsx(je,{className:`${o.className} hover:${o.className}`,children:o.label})},b=(r,o)=>{navigator.clipboard.writeText(r).then(()=>t.success(`${o} copiado!`)).catch(()=>t.error("Falha ao copiar"))};return d?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"flex items-center gap-2 font-medium text-lg",children:[e.jsx(re,{className:"h-5 w-5"}),"Histórico Financeiro (Asaas)"]}),D&&e.jsxs("p",{className:"mt-1 text-muted-foreground text-xs",children:["Última sincronização: ",x(D)]})]}),e.jsx(ge,{studentId:p})]}),!j&&e.jsxs("div",{className:"rounded-md border border-yellow-500/20 bg-yellow-500/10 p-4 text-sm text-yellow-600",children:[e.jsx("p",{className:"font-medium",children:"Aluno não sincronizado com Asaas"}),e.jsx("p",{className:"mt-1 text-xs",children:"A sincronização ocorre automaticamente ao salvar o aluno com CPF/Email válidos."})]}),i,e.jsx(de,{children:e.jsx(me,{className:"p-0",children:e.jsxs(ue,{children:[e.jsx(xe,{children:e.jsxs(O,{children:[e.jsx(m,{children:"Descrição"}),e.jsx(m,{children:"Vencimento"}),e.jsx(m,{children:"Valor"}),e.jsx(m,{children:"Status"}),e.jsx(m,{children:"Tipo"}),e.jsx(m,{className:"text-right",children:"Ações"})]})}),e.jsx(he,{children:e.jsx(O,{children:e.jsx(pe,{className:"py-8 text-center",colSpan:6,children:e.jsx(E,{className:"mx-auto h-6 w-6 animate-spin text-muted-foreground"})})})})]})})}),e.jsx(k,{onOpenChange:r=>!r&&y(null),open:!!s,children:e.jsxs(H,{className:"max-w-md",children:[e.jsxs(X,{children:[e.jsx(_,{children:"Detalhes da Cobrança"}),e.jsx(M,{children:s?.asaasPaymentId})]}),s&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx(n,{className:"text-muted-foreground",children:"Valor"}),e.jsx("p",{className:"font-medium",children:u(s.value)})]}),e.jsxs("div",{children:[e.jsx(n,{className:"text-muted-foreground",children:"Valor Líquido"}),e.jsx("p",{className:"font-medium",children:u(s.netValue??s.value)})]}),e.jsxs("div",{children:[e.jsx(n,{className:"text-muted-foreground",children:"Vencimento"}),e.jsx("p",{className:"font-medium",children:g(s.dueDate)})]}),e.jsxs("div",{children:[e.jsx(n,{className:"text-muted-foreground",children:"Status"}),f(s.status)]}),e.jsxs("div",{children:[e.jsx(n,{className:"text-muted-foreground",children:"Tipo"}),e.jsx("p",{className:"font-medium",children:s.billingType})]}),s.confirmedDate&&e.jsxs("div",{children:[e.jsx(n,{className:"text-muted-foreground",children:"Confirmado em"}),e.jsx("p",{className:"font-medium",children:x(s.confirmedDate)})]})]}),s.description&&e.jsxs(e.Fragment,{children:[e.jsx(L,{}),e.jsxs("div",{children:[e.jsx(n,{className:"text-muted-foreground",children:"Descrição"}),e.jsx("p",{className:"font-medium",children:s.description})]})]}),e.jsx(L,{}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[s.boletoUrl&&e.jsx(c,{asChild:!0,size:"sm",variant:"outline",children:e.jsxs("a",{href:s.boletoUrl,rel:"noopener noreferrer",target:"_blank",children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Ver Boleto"]})}),s.pixQrCode&&e.jsxs(c,{onClick:()=>b(s.pixQrCode??"","PIX"),size:"sm",variant:"outline",children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),"Copiar PIX"]}),e.jsx(c,{asChild:!0,size:"sm",variant:"outline",children:e.jsxs("a",{href:`https://www.asaas.com/cobrancas/${s.asaasPaymentId}`,rel:"noopener noreferrer",target:"_blank",children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),"Abrir no Asaas"]})})]})]})]})})]}):e.jsx("div",{className:"flex justify-center p-8",children:e.jsx(E,{className:"h-6 w-6 animate-spin text-muted-foreground"})})}export{we as StudentPaymentsTab};
