import{b as o,j as e}from"./vendor-C0IzTJ68.js";import{p as le,aW as ce,aX as _,ab as H,aV as de,aa as $,X as me}from"./ui-eQKuYNMj.js";import{e as q,ac as ue,ad as pe,t as fe,ae as he,D as xe,o as ge,q as je,r as ve,W as be,a4 as Ne,f as j,y as X,z,E as U,G,H as y,af as W,ag as K,ah as A,ai as x,aj as Y,ak as g,B as L,al as ye}from"./index-C8YxpUQT.js";import"./auth-CS6YH2iJ.js";import"./animation-oFsG5JPT.js";import"./forms-CH1lNzbM.js";import"./charts-CKNPyqfB.js";const Ce=ue("relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:top-4 [&>svg]:left-4 [&>svg]:text-foreground [&>svg~*]:pl-7",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),O=o.forwardRef(({className:r,variant:n,...a},l)=>e.jsx("div",{className:q(Ce({variant:n}),r),ref:l,role:"alert",...a}));O.displayName="Alert";const we=o.forwardRef(({className:r,...n},a)=>e.jsx("h5",{className:q("mb-1 font-medium leading-none tracking-tight",r),ref:a,...n}));we.displayName="AlertTitle";const R=o.forwardRef(({className:r,...n},a)=>e.jsx("div",{className:q("text-sm [&_p]:leading-relaxed",r),ref:a,...n}));R.displayName="AlertDescription";const Ee=[{key:"name",label:"Nome",required:!0},{key:"phone",label:"Telefone",required:!0},{key:"email",label:"E-mail",required:!1},{key:"profession",label:"Profissão",required:!1},{key:"message",label:"Observações",required:!1},{key:"clinicCity",label:"Cidade",required:!1},{key:"interestedProduct",label:"Produto",required:!1},{key:"source",label:"Origem",required:!1},{key:"lastContactAt",label:"Data do Contato",required:!1}],J={NOME:"name",TELEFONE:"phone","E-MAIL":"email",EMAIL:"email",CPF:null,GRADUAÇÃO:"profession","DATA DA ABORDAGEM":"lastContactAt",VENDEDOR:null,ENDEREÇO:"clinicCity",ESTADO:null,Observações:"message",OBSERVAÇÕES:"message",OBSERVACOES:"message"},Se={name:["nome","name","cliente","aluno","paciente","razao social"],phone:["telefone","phone","celular","whatsapp","tel","fone","numero"],email:["email","e-mail","mail","correio"],profession:["profissao","graduacao","formacao","especialidade","area","cargo","ocupacao"],message:["observacao","obs","mensagem","nota","comentario","anotacao"],clinicCity:["cidade","city","endereco","address","local","municipio"],interestedProduct:["produto","product","curso","interesse","servico"],source:["origem","source","canal","captacao","como conheceu"],lastContactAt:["data","date","contato","abordagem","registro"]},Ae=/^[\d\s\-()+]{10,}$/,ke=/@.*\./,De=/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;function Te(r,n=[]){const a={};for(const l of r){const m=l.toLowerCase().trim(),d=l.toUpperCase().trim();if(d in J){const u=J[d];a[l]={field:u,confidence:1,reason:u?"Mapeamento padrão OTB":"Campo ignorado"};continue}let f={field:null,confidence:0,reason:"Nenhum mapeamento encontrado"};for(const[u,c]of Object.entries(Se))for(const h of c){if(m.includes(h)){const v=h.length/m.length;v>f.confidence&&(f={field:u,confidence:Math.min(.95,v+.3),reason:`Contém "${h}"`})}const i=pe(m,h);i>f.confidence&&i>.5&&(f={field:u,confidence:i,reason:`Similar a "${h}"`})}if(n.length>0&&f.confidence<.7){const u=n.slice(0,10).map(i=>i[l]).filter(i=>i!=null&&i!=="");u.filter(i=>Ae.test(String(i))).length>=u.length*.7&&(f={field:"phone",confidence:.85,reason:"Padrão de telefone detectado"}),u.filter(i=>ke.test(String(i))).length>=u.length*.7&&(f={field:"email",confidence:.9,reason:"Padrão de e-mail detectado"})}a[l]=f}return a}function P(r,n){const a={};for(const[l,m]of Object.entries(n)){if(!m)continue;const d=r[l];d==null||d===""||(m==="phone"?a.phone=Me(String(d)):m==="lastContactAt"?a.lastContactAt=Le(d):m==="profession"?a.profession=Pe(String(d)):a[m]=String(d).trim())}return a.name&&a.phone?a:null}function Me(r){let n=r.replace(/\D/g,"");return(n.length===10||n.length===11)&&(n=`55${n}`),n}function Le(r){if(typeof r=="number")return r>4e4&&r<5e4?new Date(1899,11,30).getTime()+r*24*60*60*1e3:r;if(typeof r=="string"){const n=Date.parse(r);if(!Number.isNaN(n))return n;const a=r.match(De);if(a){const[,l,m,d]=a;return new Date(Number(d),Number(m)-1,Number(l)).getTime()}}}function Pe(r){const n=r.toLowerCase().trim();return{biomedicina:"biomedico",biomédico:"biomedico",biomedico:"biomedico",enfermagem:"enfermeiro",enfermeiro:"enfermeiro",enfermeira:"enfermeiro",medicina:"medico",médico:"medico",medico:"medico",farmácia:"farmaceutico",farmacia:"farmaceutico",farmacêutico:"farmaceutico",farmaceutico:"farmaceutico",fisioterapia:"fisioterapeuta",fisioterapeuta:"fisioterapeuta",odontologia:"dentista",dentista:"dentista",odontológico:"dentista",esteticista:"esteticista",estética:"esteticista",nutrição:"nutricionista",nutricionista:"nutricionista"}[n]??n}function Q(r,n){const a=[];return r?((!r.name||r.name.trim().length<2)&&a.push(`Linha ${n+1}: Nome muito curto ou ausente`),(!r.phone||r.phone.length<10)&&a.push(`Linha ${n+1}: Telefone inválido`),r.email&&!r.email.includes("@")&&a.push(`Linha ${n+1}: E-mail inválido`),{valid:a.length===0,errors:a}):{valid:!1,errors:["Dados insuficientes"]}}function Oe(r,n){return r?"Mapeie a coluna de Telefone (obrigatório)":n?"Mapeie a coluna de Nome (obrigatório)":"Mapeie as colunas de Nome e Telefone (obrigatórios)"}function He({open:r,onOpenChange:n}){const[a,l]=o.useState("upload"),[m,d]=o.useState(null),[f,u]=o.useState([]),[c,h]=o.useState([]),[i,v]=o.useState({}),[C,Z]=o.useState("otb"),[b,I]=o.useState(null),[ee,N]=o.useState(!1),[F,w]=o.useState(null),V=fe.leads.importLeads.useMutation(),B=o.useCallback(()=>{l("upload"),d(null),u([]),h([]),v({}),I(null),w(null),N(!1)},[]),k=o.useCallback(()=>{B(),n(!1)},[n,B]),E=o.useCallback(async s=>{d(s),w(null),N(!0);try{const t=await he(s);if(!(t.data.headers.length&&t.data.rows.length))throw new Error("Arquivo vazio ou sem dados válidos");u(t.data.headers),h(t.data.rows);const p=Te(t.data.headers,t.data.rows),S={};for(const[ie,oe]of Object.entries(p))S[ie]=oe.field;v(S),l("mapping")}catch(t){w(t instanceof Error?t.message:"Erro ao processar arquivo")}finally{N(!1)}},[]),ae=o.useCallback(s=>{s.preventDefault();const t=s.dataTransfer.files[0];t&&E(t)},[E]),se=o.useCallback(s=>{const t=s.target.files?.[0];t&&E(t)},[E]),te=o.useCallback((s,t)=>{v(p=>({...p,[s]:t}))},[]),re=o.useCallback(()=>c.slice(0,10).map((s,t)=>{const p=P(s,i),S=Q(p,t);return{raw:s,transformed:p,validation:S,index:t}}),[c,i]),D=o.useCallback(()=>{let s=0;for(let t=0;t<c.length;t++){const p=P(c[t],i);p&&Q(p,t).valid&&s++}return s},[c,i]),ne=o.useCallback(async()=>{l("importing"),N(!0);try{const s=c.map(p=>P(p,i)).filter(p=>p!==null),t=await V.mutateAsync({leads:s,defaultProduct:C});I(t),l("complete"),t.success>0&&le.success(`${t.success} leads importados com sucesso!`)}catch(s){w(s instanceof Error?s.message:"Erro na importação"),l("preview")}finally{N(!1)}},[c,i,C,V]),T=Object.values(i).includes("name"),M=Object.values(i).includes("phone");return e.jsx(xe,{onOpenChange:k,open:r,children:e.jsxs(ge,{className:"flex max-h-[90vh] max-w-4xl flex-col overflow-hidden",children:[e.jsxs(je,{children:[e.jsxs(ve,{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-5 w-5"}),"Importar Leads"]}),e.jsxs(be,{children:[a==="upload"&&"Selecione um arquivo XLSX ou CSV para importar leads",a==="mapping"&&"Mapeie as colunas da planilha para os campos de lead",a==="preview"&&"Revise os dados antes de importar",a==="importing"&&"Importando leads...",a==="complete"&&"Importação concluída"]})]}),e.jsx("div",{className:"flex items-center gap-2 py-2",children:["upload","mapping","preview","complete"].map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${a===s||["mapping","preview","complete"].indexOf(a)>t-1?"bg-primary":"bg-muted"}`}),t<3&&e.jsx("div",{className:"h-px w-8 bg-muted"})]},s))}),F&&e.jsxs(O,{variant:"destructive",children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx(R,{children:F})]}),e.jsxs(Ne,{className:"flex-1 pr-4",children:[a==="upload"&&e.jsx("button",{className:"w-full cursor-pointer rounded-lg border-2 border-muted border-dashed bg-transparent p-12 text-center transition-colors hover:border-primary/50",onDragOver:s=>s.preventDefault(),onDrop:ae,type:"button",children:ee?e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(H,{className:"h-12 w-12 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Processando arquivo..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"mx-auto mb-4 h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"mb-2 font-medium text-lg",children:"Arraste e solte seu arquivo aqui"}),e.jsx("p",{className:"mb-4 text-muted-foreground",children:"ou"}),e.jsxs("label",{children:[e.jsx("input",{accept:".xlsx,.xls,.csv",className:"hidden",onChange:se,type:"file"}),e.jsx(j,{asChild:!0,variant:"outline",children:e.jsx("span",{children:"Selecionar Arquivo"})})]}),e.jsx("p",{className:"mt-4 text-muted-foreground text-xs",children:"Formatos suportados: XLSX, XLS, CSV"})]})}),a==="mapping"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Arquivo: ",e.jsx("strong",{children:m?.name})," (",c.length," linhas)"]}),e.jsxs(X,{onValueChange:Z,value:C,children:[e.jsx(z,{className:"w-40",children:e.jsx(U,{placeholder:"Produto padrão"})}),e.jsxs(G,{children:[e.jsx(y,{value:"otb",children:"OTB 2026"}),e.jsx(y,{value:"black_neon",children:"Black Neon"}),e.jsx(y,{value:"trintae3",children:"TrintaE3"})]})]})]}),T&&M?null:e.jsxs(O,{children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx(R,{children:Oe(T,M)})]}),e.jsxs(W,{children:[e.jsx(K,{children:e.jsxs(A,{children:[e.jsx(x,{children:"Coluna da Planilha"}),e.jsx(x,{children:"Mapear para"}),e.jsx(x,{children:"Amostra"})]})}),e.jsx(Y,{children:f.map(s=>e.jsxs(A,{children:[e.jsx(g,{className:"font-medium",children:s}),e.jsx(g,{children:e.jsxs(X,{onValueChange:t=>te(s,t==="skip"?null:t),value:i[s]??"skip",children:[e.jsx(z,{className:"w-40",children:e.jsx(U,{})}),e.jsxs(G,{children:[e.jsx(y,{value:"skip",children:e.jsx("span",{className:"text-muted-foreground",children:"— Ignorar —"})}),Ee.map(t=>e.jsxs(y,{value:t.key,children:[t.label,t.required&&e.jsx("span",{className:"ml-1 text-destructive",children:"*"})]},t.key))]})]})}),e.jsx(g,{className:"max-w-[200px] truncate text-muted-foreground text-sm",children:String(c[0]?.[s]??"")})]},s))})]})]}),a==="preview"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[D()," de ",c.length," leads válidos"]}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Leads com erros serão ignorados na importação"})]}),e.jsxs(L,{variant:"secondary",children:["Produto: ",C.toUpperCase()]})]}),e.jsxs(W,{children:[e.jsx(K,{children:e.jsxs(A,{children:[e.jsx(x,{className:"w-12",children:"#"}),e.jsx(x,{children:"Nome"}),e.jsx(x,{children:"Telefone"}),e.jsx(x,{children:"E-mail"}),e.jsx(x,{children:"Status"})]})}),e.jsx(Y,{children:re().map(s=>e.jsxs(A,{children:[e.jsx(g,{className:"text-muted-foreground",children:s.index+1}),e.jsx(g,{children:s.transformed?.name??"—"}),e.jsx(g,{children:s.transformed?.phone??"—"}),e.jsx(g,{children:s.transformed?.email??"—"}),e.jsx(g,{children:s.validation.valid?e.jsxs(L,{className:"bg-green-600",variant:"default",children:[e.jsx($,{className:"mr-1 h-3 w-3"}),"OK"]}):e.jsxs(L,{variant:"destructive",children:[e.jsx(me,{className:"mr-1 h-3 w-3"}),"Erro"]})})]},s.index))})]}),c.length>10&&e.jsxs("p",{className:"text-center text-muted-foreground text-sm",children:["Mostrando 10 de ",c.length," linhas"]})]}),a==="importing"&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(H,{className:"h-12 w-12 animate-spin text-primary"}),e.jsx("p",{className:"font-medium text-lg",children:"Importando leads..."}),e.jsx(ye,{className:"w-64",value:50})]}),a==="complete"&&b&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"py-8 text-center",children:[e.jsx($,{className:"mx-auto mb-4 h-16 w-16 text-green-600"}),e.jsx("p",{className:"mb-2 font-bold text-2xl",children:"Importação Concluída"}),e.jsxs("p",{className:"text-muted-foreground",children:[b.success," leads criados • ",b.failed," ignorados"]})]}),b.failed>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-sm",children:"Erros encontrados:"}),e.jsx("div",{className:"max-h-40 overflow-auto rounded border p-2 text-sm",children:b.results.filter(s=>!s.success).slice(0,10).map(s=>e.jsxs("p",{className:"text-destructive",children:["Linha ",s.index+1,": ",s.error]},s.index))})]})]})]}),e.jsxs("div",{className:"flex justify-between border-t pt-4",children:[e.jsx(j,{onClick:k,variant:"ghost",children:a==="complete"?"Fechar":"Cancelar"}),e.jsxs("div",{className:"flex gap-2",children:[a==="mapping"&&e.jsxs(e.Fragment,{children:[e.jsx(j,{onClick:()=>l("upload"),variant:"outline",children:"Voltar"}),e.jsx(j,{disabled:!(T&&M),onClick:()=>l("preview"),children:"Próximo"})]}),a==="preview"&&e.jsxs(e.Fragment,{children:[e.jsx(j,{onClick:()=>l("mapping"),variant:"outline",children:"Voltar"}),e.jsxs(j,{disabled:D()===0,onClick:ne,children:["Importar ",D()," Leads"]})]}),a==="complete"&&e.jsx(j,{onClick:k,children:"Concluir"})]})]})]})})}export{He as LeadImportDialog};
